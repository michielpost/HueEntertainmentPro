@page "/bridge/{Id:guid}"
@page "/bridge/{*Ip}"
@using HueApi.Models.Clip
@using HueEntertainmentPro.Client.Services
@using HueEntertainmentPro.Client.Shared.ResourceExplorerComponents
@using HueEntertainmentPro.Shared.Interfaces
@using HueEntertainmentPro.Shared.Models
@using HueEntertainmentPro.Shared.Models.Requests
@using HueLightDJ.Services.Interfaces
@using HueLightDJ.Services.Interfaces.Models
@using System.Text.Json
@inject IBridgeDataService BridgeService
@inject IHueSetupService HueSetupService
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject IToastService ToastService
@inject ResourceExplorerService ResourceExplorerService

<PageTitle>Bridge Details</PageTitle>

<h3>Bridge Details</h3>

@if (errorMessage != null)
{
    <FluentMessageBar Intent="MessageIntent.Error" Style="margin-bottom: 16px;">
        @errorMessage
    </FluentMessageBar>
}

@if (bridge != null)
{
    <FluentStack Orientation="Orientation.Vertical" Gap="10">
        <FluentLabel Typo="Typography.Header">Name: @bridge.Name</FluentLabel>
        <FluentLabel Typo="Typography.Header">Bridge ID: @bridge.BridgeId</FluentLabel>
        <FluentLabel Typo="Typography.Header">ip: @bridge.Ip</FluentLabel>
        <FluentStack Orientation="Orientation.Horizontal" Gap="10">
            <FluentButton Appearance="Appearance.Accent" @onclick="ShowEditNameDialog">Edit Name</FluentButton>
            <FluentButton Appearance="Appearance.Neutral" @onclick="ShowDeleteConfirmation">Delete Bridge</FluentButton>
        </FluentStack>
    </FluentStack>


    <h4 style="margin-top: 20px;">Entertainment Groups</h4>
    @if (entertainmentGroups == null)
    {
        <FluentProgressRing>Loading entertainment groups...</FluentProgressRing>
    }
    else if (entertainmentGroups.Any())
    {
        <FluentDataGrid Items="@entertainmentGroups" TGridItem="SimpleEntertainmentGroup">
            <PropertyColumn Title="Name" Property="@(g => g.Name)" Sortable="true" Align="Align.Start" />
            <PropertyColumn Title="Lights" Property="@(g => g.LightCount)" Sortable="true" Align="Align.Start" />
        </FluentDataGrid>
    }
    else
    {
        <FluentLabel>No entertainment groups found for this bridge.</FluentLabel>
    }


}
else if (Id.HasValue)
{
    <FluentProgressRing>Loading bridge details...</FluentProgressRing>
}

@if (bridgeConfig == null)
{
    <FluentProgressRing>Loading bridge config...</FluentProgressRing>
}
else
{
    <h4 style="margin-top: 20px;">Bridge Config</h4>
    <p>
        @if (Id.HasValue)
        {
            <span>
                Explore more bridge details on the <a href="/resource-explorer/@Id">Resource Explorer</a>.
            </span>
            <br />
        }
        View <a href="http://@Ip/description.xml" target="_blank">description.xml</a>.<br />
    </p>

    <JsonViewer Element="@JsonSerializer.SerializeToElement(bridgeConfig)" />
}

@code {
    [Parameter]
    public Guid? Id { get; set; }

    [Parameter]
    public string? Ip { get; set; }

    private Bridge? bridge;
    private BridgeConfig? bridgeConfig;
    private IQueryable<SimpleEntertainmentGroup>? entertainmentGroups;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            bridgeConfig = null;
            entertainmentGroups = null;

            // Load bridge details
            if (Id.HasValue)
            {
                bridge = await BridgeService.GetBridge(new GuidRequest() { Id = Id.Value });
                Ip = bridge?.Ip;
            }

            if (bridge == null && Ip == null)
            {
                errorMessage = "Bridge not found.";
                return;
            }

            if (bridge != null)
            {
                //TODO: Why does fail when using bridge (which includes key) and returns more data?
                var localHueClient = ResourceExplorerService.GetHueClient(bridge.Ip);
                bridgeConfig = await localHueClient.GetConfigAsync();

                // Load entertainment groups
                var result = await HueSetupService.GetEntertainmentGroupsAsync(new HueLightDJ.Services.Interfaces.Models.Requests.HueSetupRequest()
                {
                    Ip = bridge.Ip,
                    Key = bridge.Username
                });
                entertainmentGroups = result.Groups.AsQueryable();
            }
            else if (Ip != null)
            {
                var localHueClient = ResourceExplorerService.GetHueClient(Ip);
                bridgeConfig = await localHueClient.GetConfigAsync();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load bridge details: {ex.Message}";
        }
    }

    private async Task ShowEditNameDialog()
    {
        if (bridge == null)
            return;

        var dialogParameters = new DialogParameters
        {
            Title = "Edit Bridge Name",
            PrimaryAction = "Save",
            SecondaryAction = "Cancel",
            Width = "400px",
            Modal = true
        };

        var dialog = await DialogService.ShowDialogAsync<EditNameDialog>(bridge.Name ?? string.Empty, dialogParameters);
        var result = await dialog.Result;

        if (!result.Cancelled && result.Data is string newName && !string.IsNullOrWhiteSpace(newName))
        {
            try
            {
                //Console.WriteLine("Cancelled:" + result.Cancelled);

                var bridgeResult = await BridgeService.UpdateBridge(new UpdateBridgeRequest() { Id = bridge.Id, Name = newName });
                bridge = bridgeResult;
                ToastService.ShowSuccess("Bridge name updated successfully.");
                StateHasChanged();
            }
            catch (Exception ex)
            {
                ToastService.ShowError($"Failed to update bridge name: {ex.Message}");
            }
        }
    }

    private async Task ShowDeleteConfirmation()
    {
        if (bridge == null)
            return;

        var dialog = await DialogService.ShowConfirmationAsync(
            "Are you sure you want to delete this bridge?"
            , "Delete", "Cancel", "Confirm Delete");

        var result = await dialog.Result;

        if (!result.Cancelled)
        {
            try
            {
                await BridgeService.DeleteBridge(new GuidRequest { Id = bridge.Id });
                ToastService.ShowSuccess("Bridge deleted successfully.");
                Navigation.NavigateTo("/bridges");
            }
            catch (Exception ex)
            {
                ToastService.ShowError($"Failed to delete bridge: {ex.Message}");
            }
        }
    }
}
